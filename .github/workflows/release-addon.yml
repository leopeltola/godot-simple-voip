name: Release Godot Addon

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build and publish (example: v0.3.2)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust release library
        run: cargo build --release --manifest-path rust/Cargo.toml

      - name: Package Godot addon
        id: package
        shell: pwsh
        run: |
          $tag = "${{ env.RELEASE_TAG }}"
          $archiveName = "godot-simple-voip-$tag.zip"
          $packageRoot = "godot-simple-voip-$tag"
          $stagingDir = Join-Path $env:RUNNER_TEMP $packageRoot
          $addonDir = Join-Path $stagingDir "addons/godot_simple_voip"
          $addonBinDir = Join-Path $addonDir "bin"
          $releaseDll = "rust/target/release/simple_voip.dll"

          New-Item -ItemType Directory -Path $addonDir -Force | Out-Null
          New-Item -ItemType Directory -Path $addonBinDir -Force | Out-Null

          Copy-Item -Path "addons/godot_simple_voip/*" -Destination $addonDir -Recurse -Force

          if (-not (Test-Path $releaseDll)) {
            throw "Expected release DLL not found at '$releaseDll'"
          }

          Copy-Item -Path $releaseDll -Destination (Join-Path $addonBinDir "simple_voip.dll") -Force

          if (Test-Path "LICENSE") {
            Copy-Item -Path "LICENSE" -Destination $stagingDir -Force
          }

          $archivePath = Join-Path $env:GITHUB_WORKSPACE $archiveName
          if (Test-Path $archivePath) {
            Remove-Item -Path $archivePath -Force
          }

          Compress-Archive -Path "$stagingDir/*" -DestinationPath $archivePath

          "archive_path=$archivePath" >> $env:GITHUB_OUTPUT

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Godot Simple VOIP ${{ env.RELEASE_TAG }}
          generate_release_notes: true
          files: ${{ steps.package.outputs.archive_path }}
